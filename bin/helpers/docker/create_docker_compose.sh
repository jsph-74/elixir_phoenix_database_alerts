#!/bin/bash
set -e

# Usage: create_docker_compose.sh <env> [db_encryption_secret] [secret_key_base_secret] [master_password_secret]
ENV="${1:-dev}"
DB_ENCRYPTION_SECRET_NAME="$2"
SECRET_SECRET_NAME="$3"
MASTER_PASSWORD_SECRET_NAME="$4"

# Source shared functions
source "$(dirname "$0")/../functions.sh"

echo "üîÑ Generating docker-compose-${ENV}.yaml from template..."

# Get ports for environment
HTTP_PORT=$(get_http_port "$ENV")
HTTPS_PORT=$(get_https_port "$ENV")

# Set database port based on environment
case "$ENV" in
    dev) DB_PORT="5430" ;;
    test) DB_PORT="5431" ;;
    prod) DB_PORT="5432" ;;
    *) DB_PORT="5432" ;;
esac

# Get secret names from helper if not provided as parameters
if [ -z "$DB_ENCRYPTION_SECRET_NAME" ]; then
    DB_ENCRYPTION_SECRET_NAME=$($(dirname "$0")/../crypto/get_secret_name.sh "$ENV" db_encryption_key)
fi
if [ -z "$SECRET_SECRET_NAME" ]; then
    SECRET_SECRET_NAME=$($(dirname "$0")/../crypto/get_secret_name.sh "$ENV" secret_key_base)
fi
if [ -z "$MASTER_PASSWORD_SECRET_NAME" ]; then
    MASTER_PASSWORD_SECRET_NAME=$($(dirname "$0")/../crypto/get_secret_name.sh "$ENV" master_password)
fi

# Check if required secret names are available
if [ -z "$DB_ENCRYPTION_SECRET_NAME" ] || [ -z "$SECRET_SECRET_NAME" ]; then
    print_status "‚ùå Secret names not found. Run secrets.sh first" $RED
    exit 1
fi

# Master password secret is optional - skip if not set
if [ -z "$MASTER_PASSWORD_SECRET_NAME" ]; then
    MASTER_PASSWORD_SECRET_NAME="master_password_placeholder"
    SKIP_MASTER_PASSWORD=true
else
    SKIP_MASTER_PASSWORD=false
fi

# Generate environment-specific docker-compose file from template
# Use multiple sed commands to avoid character escaping issues
cp docker-compose.tpl.yaml docker-compose-${ENV}.yaml

# Add auto-generation notice at the top
sed -i "" "1i\\
# WARNING: This file is auto-generated from docker-compose.tpl.yaml\\
# Do not edit this file directly. Edit the template instead.\\
# Generated on $(date) for environment: ${ENV}\\
" docker-compose-${ENV}.yaml
sed -i "" "s/{{ENV}}/$ENV/g" docker-compose-${ENV}.yaml
sed -i "" "s/{{HTTP_PORT}}/$HTTP_PORT/g" docker-compose-${ENV}.yaml
sed -i "" "s/{{HTTPS_PORT}}/$HTTPS_PORT/g" docker-compose-${ENV}.yaml
sed -i "" "s/{{DB_PORT}}/$DB_PORT/g" docker-compose-${ENV}.yaml
sed -i "" "s/{{DATABASE_NAME}}/alerts_$ENV/g" docker-compose-${ENV}.yaml
sed -i "" "s/{{DB_ENCRYPTION_SECRET_NAME}}/$DB_ENCRYPTION_SECRET_NAME/g" docker-compose-${ENV}.yaml
sed -i "" "s/{{SECRET_SECRET_NAME}}/$SECRET_SECRET_NAME/g" docker-compose-${ENV}.yaml
# Handle master password conditionally
if [ "$SKIP_MASTER_PASSWORD" = "true" ]; then
    # Remove master password placeholders
    sed -i "" "s/{{MASTER_PASSWORD_MOUNT}}//g" docker-compose-${ENV}.yaml
    sed -i "" "s/{{MASTER_PASSWORD_SECRET}}//g" docker-compose-${ENV}.yaml
else
    # Replace master password placeholders with actual content
    MASTER_PASSWORD_MOUNT="
      - source: $MASTER_PASSWORD_SECRET_NAME
        target: master_password"
    MASTER_PASSWORD_SECRET="
  $MASTER_PASSWORD_SECRET_NAME:
    external: true"
    
    sed -i "" "s|{{MASTER_PASSWORD_MOUNT}}|$MASTER_PASSWORD_MOUNT|g" docker-compose-${ENV}.yaml
    sed -i "" "s|{{MASTER_PASSWORD_SECRET}}|$MASTER_PASSWORD_SECRET|g" docker-compose-${ENV}.yaml
fi

# Handle ENCRYPTION_KEY_VALUE separately with a different delimiter to avoid base64 issues
sed -i "" "s|{{ENCRYPTION_KEY_VALUE}}|$ENCRYPTION_KEY|g" docker-compose-${ENV}.yaml

# Handle conditional sections based on environment
if [ "$ENV" = "dev" ] || [ "$ENV" = "test" ]; then
    # Include Playwright section for dev/test
    sed -i "" "s/{{IF_DEV_TEST}}//g" docker-compose-${ENV}.yaml
    sed -i "" "s/{{END_IF_DEV_TEST}}//g" docker-compose-${ENV}.yaml
else
    # Remove Playwright section for production
    sed -i "" "/{{IF_DEV_TEST}}/,/{{END_IF_DEV_TEST}}/d" docker-compose-${ENV}.yaml
fi

print_status "‚úÖ Generated docker-compose-${ENV}.yaml with:" $GREEN
echo "  ‚Ä¢ Environment: $ENV"
echo "  ‚Ä¢ HTTP Port: $HTTP_PORT"  
echo "  ‚Ä¢ HTTPS Port: $HTTPS_PORT"
echo "  ‚Ä¢ Database Port: $DB_PORT"
echo "  ‚Ä¢ Encryption Secret: $DB_ENCRYPTION_SECRET_NAME"
echo "  ‚Ä¢ Secret Key Secret: $SECRET_SECRET_NAME"
echo "  ‚Ä¢ Master Password Secret: $MASTER_PASSWORD_SECRET_NAME"